<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Gimnasio con Firebase</title>
  <style>
    body { background:#121212; color:#ffffff; font-family:Arial,sans-serif; margin:0; }
    header { background:#1f1f1f; padding:1rem; text-align:center; font-size:1.5rem; }
    main { display:flex; }
    nav { width:200px; background:#1a1a1a; min-height:100vh; padding:1rem; }
    nav button { display:block; width:100%; margin:.5rem 0; padding:.5rem; background:#333; border:none; color:#ffffff; cursor:pointer; border-radius:5px; }
    section { flex:1; padding:1rem; display:none; }
    section.active { display:block; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { border:1px solid #444; padding:.5rem; text-align:left; }
    input,select { padding:.3rem; margin:.2rem 0; border-radius:4px; border:1px solid #444; background:#222; color:#ffffff; }
    .history-filters { margin:1rem 0; }
  </style>
</head>
<body>
  <header>üèãÔ∏è Sistema de Gimnasio (Firebase)</header>
  <main>
    <nav>
      <button onclick="show('members')">Miembros</button>
      <button onclick="show('attendance')">Registro de Asistencia / Pagos del d√≠a</button>
      <button onclick="show('history')">Historial</button>
    </nav>
    <section id="members" class="active">
      <h2>Miembros</h2>
      <form onsubmit="addMember(event)">
        <input id="memberName" placeholder="Nombre" required>
        <input id="memberDays" type="number" placeholder="D√≠as" required>
        <input id="memberAmount" type="number" placeholder="Pago $" required>
        <button>Registrar</button>
      </form>
      <table>
        <thead><tr><th>Nombre</th><th>Inicio</th><th>Fin</th><th>Pago</th><th>Acciones</th></tr></thead>
        <tbody id="membersTbody"></tbody>
      </table>
    </section>
    <section id="attendance">
      <h2>Registro de Visitas / Zumba</h2>
      <form onsubmit="addVisit(event)">
        <input id="visitName" placeholder="Nombre visitante" required>
        <input id="visitAmount" type="number" placeholder="Pago $" required>
        <select id="visitType">
          <option value="Visita">Visita</option>
          <option value="Zumba">Zumba</option>
        </select>
        <button>Registrar</button>
      </form>
      <table>
        <thead><tr><th>Nombre</th><th>Tipo</th><th>Pago</th><th>Fecha</th></tr></thead>
        <tbody id="visitsTbody"></tbody>
      </table>
    </section>
    <section id="history">
      <h2>Historial</h2>
      <div class="history-filters">
        <label>Tipo:</label>
        <select id="filterType" onchange="renderHistory()">
          <option value="all">Todos</option>
          <option value="Membres√≠a">Membres√≠as</option>
          <option value="Visita">Visitas</option>
          <option value="Zumba">Zumba</option>
          <option value="Asistencia">Asistencias</option>
        </select>
      </div>
      <table>
        <thead><tr><th>Fecha</th><th>Tipo</th><th>Persona</th><th>Monto</th><th>Detalle</th></tr></thead>
        <tbody id="historyTbody"></tbody>
      </table>
      <p id="totalHistory">Ganancia total: $0</p>
    </section>
  </main>

  <!-- ==== MODAL ==== -->
  <div id="attendanceModal" style="
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center;
  ">
    <div style="background:#1e1e1e; padding:2rem; border-radius:10px; text-align:center; max-width:400px; box-shadow:0 0 15px #000;">
      <h2 id="modalTitle">üëã Bienvenido</h2>
      <p id="modalMessage" style="margin:1rem 0; font-size:1.1rem; color:#ccc;"></p>
      <button onclick="closeModal()" style="padding:0.5rem 1rem; border:none; border-radius:5px; background:#444; color:#eee; cursor:pointer;">Cerrar</button>
    </div>
  </div>

  <!-- ==== FIREBASE ==== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
       apiKey: "AIzaSyDWEWKwyx1hsUXt9VyHKYueB2Mb3XmxraY",
       authDomain: "gimnasio-system.firebaseapp.com",
       projectId: "gimnasio-system",
       storageBucket: "gimnasio-system.firebasestorage.app",
       messagingSenderId: "591457546318",
       appId: "1:591457546318:web:7301e83f82f6455d96931f",
       measurementId: "G-LLHCVVRYR3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const el=id=>document.getElementById(id);
    const fmt=d=> new Date(d.seconds?d.seconds*1000:d).toLocaleString();

    // ==== NAV ====
    window.show=id=>{
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      el(id).classList.add("active");
    };

    // ==== HISTORIAL ====
    async function logHistory(type,person,amount,detail){
      await addDoc(collection(db,"history"),{
        date:serverTimestamp(),
        type,person,amount,detail
      });
    }

    function renderHistory(){
      const type=el("filterType").value;
      onSnapshot(collection(db,"history"),snap=>{
        let list=snap.docs.map(d=>({id:d.id,...d.data()}));
        if(type!=="all") list=list.filter(h=>h.type===type);
        el("historyTbody").innerHTML=list.map(h=>`
          <tr>
            <td>${fmt(h.date)}</td>
            <td>${h.type}</td>
            <td>${h.person}</td>
            <td>$${h.amount?.toFixed(2) || 0}</td>
            <td>${h.detail||''}</td>
          </tr>`).join('');
        const total=list.reduce((s,h)=>s+(h.amount||0),0);
        el("totalHistory").textContent=`Ganancia total: $${total.toFixed(2)}`;
      });
    }

    // ==== MIEMBROS ====
    window.addMember=async e=>{
      e.preventDefault();
      const name=el("memberName").value;
      const days=+el("memberDays").value;
      const amount=+el("memberAmount").value;
      const start=new Date();
      const end=new Date(start); end.setDate(end.getDate()+days);

      await addDoc(collection(db,"members"),{
        name,days,amount,start,end
      });
      await logHistory("Membres√≠a",name,amount,`Membres√≠a de ${days} d√≠as`);
      e.target.reset();
    };

    function renderMembers(){
      onSnapshot(collection(db,"members"),snap=>{
        const list=snap.docs.map(d=>({id:d.id,...d.data()}));
        el("membersTbody").innerHTML=list.map(m=>`
          <tr>
            <td>${m.name}</td>
            <td>${fmt(m.start)}</td>
            <td>${fmt(m.end)}</td>
            <td>$${m.amount.toFixed(2)}</td>
            <td>
              <button onclick="renewMember('${m.id}','${m.name}','${m.end.toDate()}')">Renovar</button>
              <button onclick="markAttendance('${m.name}','${m.end.toDate()}')">Asistencia</button>
            </td>
          </tr>`).join('');
      });
    }

    window.renewMember=async (id,name,endDate)=>{
      const extra=prompt("¬øCu√°ntos d√≠as renovar?");
      const pay=prompt("Pago recibido $");
      if(extra&&pay){
        const newEnd=new Date(endDate);
        newEnd.setDate(newEnd.getDate()+(+extra));
        await updateDoc(doc(db,"members",id),{ end:newEnd });
        await logHistory("Membres√≠a",name,+pay,`Renovaci√≥n de ${extra} d√≠as`);
      }
    };

    // ==== VISITAS / ZUMBA ====
    window.addVisit=async e=>{
      e.preventDefault();
      const name=el("visitName").value;
      const amount=+el("visitAmount").value;
      const type=el("visitType").value;
      await addDoc(collection(db,"visits"),{name,amount,type,date:serverTimestamp()});
      await logHistory(type,name,amount,"Pago por "+type);
      e.target.reset();
    };

    function renderVisits(){
      onSnapshot(collection(db,"visits"),snap=>{
        const list=snap.docs.map(d=>({id:d.id,...d.data()}));
        el("visitsTbody").innerHTML=list.map(v=>`
          <tr>
            <td>${v.name}</td>
            <td>${v.type}</td>
            <td>$${v.amount.toFixed(2)}</td>
            <td>${fmt(v.date)}</td>
          </tr>`).join('');
      });
    }

    // ==== ASISTENCIA ====
    window.markAttendance=async (name,endDate)=>{
      const today=new Date();
      const diff=Math.ceil((new Date(endDate)-today)/(1000*60*60*24));
      await logHistory("Asistencia",name,0,"Registro de asistencia");
      el("modalTitle").textContent=`üëã Bienvenido ${name}`;
      el("modalMessage").textContent=`Te quedan ${diff} d√≠as de membres√≠a.`;
      el("attendanceModal").style.display="flex";
    };
    window.closeModal=()=> el("attendanceModal").style.display="none";

    // ==== INIT ====
    renderMembers();
    renderVisits();
    renderHistory();
  </script>
</body>
</html>
